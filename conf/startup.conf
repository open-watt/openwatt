# Startup script

/system/update-rate rate=20
/system/log-level level=debug

# add a login/password for testing
/secret/add name=test password=password services=admin,wifi,vpn,rpcap

# Configure serial streams for various RS485 bridges
/stream/tcp-client
add name=meterbox.1 remote=192.168.3.7:8001
add name=meterbox.2 remote=192.168.3.7:8002
add name=meterbox.3 remote=192.168.3.7:8003
add name=meterbox.4 remote=192.168.3.7:8004
add name=meterbox.5 remote=192.168.3.7:8005
add name=meterbox.6 remote=192.168.3.7:8006
add name=meterbox.7 remote=192.168.3.7:8007
add name=meterbox.8 remote=192.168.3.7:8008
add name=cabin_switchboard remote=192.168.1.7:8899
add name=carport remote=192.168.3.11 port=8899
add name=shed remote=192.168.3.12:8899
add name=can.1 remote=192.168.3.14:8001
add name=can.2 remote=192.168.3.14:8002

/stream/serial/add name=com3 device=COM3 baud-rate=230400 flow-control=software
#/stream/serial/add name=com4 device=COM6 baud-rate=115200 flow-control=software
#/stream/serial/add name=com5 device=COM5 baud-rate=230400 flow-control=hardware

# Create modbus interfaces
/interface/modbus
add name=se_inverter stream=meterbox.1 protocol=rtu
add name=se_meter stream=meterbox.2 protocol=rtu master=true
add name=goodwe_inverter stream=meterbox.5 protocol=rtu
add name=goodwe_meter stream=meterbox.6 protocol=rtu master=true
add name=goodwe_ems stream=meterbox.7 protocol=rtu master=true
add name=pace_bms stream=meterbox.4 protocol=rtu master=true
add name=cabin_switchboard stream=cabin_switchboard protocol=rtu master=true

# populate the modbus interfaces with devices
/interface/modbus/remote-server
#add name=se_meter interface=se_meter address=2 universal-address=2 profile=se_meter
add name=se_meter interface=se_inverter address=2 universal-address=2 profile=se_meter
#add name=goodwe_meter interface=goodwe_meter address=3 universal-address=3 profile=goodwe_meter
add name=goodwe_meter interface=goodwe_inverter address=3 universal-address=3 profile=gm1000
add name=goodwe_ems interface=goodwe_ems address=247 profile=goodwe_ems model=gw5000-sbp-20
add name=pace_bms_pack1 interface=pace_bms address=1 profile=pace_bms  # interval=0ms delay=35ms timeout=1000ms
add name=pace_bms_pack2 interface=pace_bms address=2 profile=pace_bms  # interval=0ms delay=35ms timeout=1000ms
#add name=cabin_main_meter interface=cabin_switchboard address=1 profile=tac1100  # interval=1300ms

# create a modbus bridge
/interface/bridge
add name=modbus_bridge
#port add bridge=modbus_bridge interface=se_inverter
#port add bridge=modbus_bridge interface=goodwe_inverter
port add bridge=modbus_bridge interface=se_meter
port add bridge=modbus_bridge interface=goodwe_meter
port add bridge=modbus_bridge interface=goodwe_ems
port add bridge=modbus_bridge interface=pace_bms
port add bridge=modbus_bridge interface=cabin_switchboard


# Create CAN interfaces
/interface/can
add name=goodwe_can stream=can.1 protocol=ebyte


#GoodWe inverters
#/protocol/goodwe/aa55/add name=house_battery remote=192.168.3.4
/protocol/goodwe/aa55/add name=cabin_solar remote=192.168.3.5 profile=gwxx48es model=gw5048es
/protocol/goodwe/device/add id=cabin_solar aa55-client=cabin_solar

# Tesla TWC interfaces
#/interface/tesla-twc add name=carport_twc stream=carport
/interface/tesla-twc add name=shed_twc stream=shed

# Bridge two TWCs
#/interface/bridge add name=tesla_bridge
#/interface/bridge/port add bridge=tesla_bridge interface=carport_twc
#/interface/bridge/port add bridge=tesla_bridge interface=shed_twc

# Create TWC master contrllers
#/protocol/tesla/twc/add name=carport_twc interface=carport_twc id=0x6914 max-current=32
#/protocol/tesla/twc/add name=shed_twc interface=shed_twc id=0x6820 max-current=25


# MQTT server
/protocol/mqtt/broker add name=mqtt port=1883
/secret add name=homeassistant password=qqqqqqqqqq services=mqtt



# Zigbee/Thread radio

/tools/pcap/add name=zb_cap file="zb_cap.pcapng"

/protocol/ezsp/client/add name=zbdongle stream=com3
/interface/zigbee/add name=zb ezsp-client=zbdongle pcap=zb_cap
/protocol/zigbee/coordinator/add name=zb-coordinator interface=zb channel=auto
/protocol/zigbee/endpoint/add name=zb-manager node=zb-coordinator endpoint-id=1 profile=ha device=0x0007 in-clusters=0,3,0xA,0xB05,0xEF00  out-clusters=3,4,5,6,8,0x101,0x102,0x201,0x202,0x300,0x400,0x402,0x405,0x403,0x702,0xB04,0xEF00
/protocol/zigbee/controller/add name=zb-controller endpoint=zb-manager auto-create=true

#/protocol/spinel/client/add name=zbgw04 stream=com5

#------------------------------------------------------------------------------------------
# Setup 'devices' to sample and record data...

# Snoop the SolarEdge inverter
/protocol/modbus/client add name=se_mb interface=se_inverter snoop=true
/protocol/modbus/device add id=se_meter client=se_mb slave=se_meter

# Snoop the GoodWe inverter
/protocol/modbus/client add name=goodwe_mb interface=goodwe_inverter snoop=true
/protocol/modbus/device add id=goodwe_meter client=goodwe_mb slave=goodwe_meter

# Misc modbus servers
/protocol/modbus/client add name=mb interface=modbus_bridge
/protocol/modbus/device add id=goodwe_ems client=mb slave=goodwe_ems
#/protocol/modbus/device add id=pace_bms_pack1 client=mb slave=pace_bms_pack1
#/protocol/modbus/device add id=pace_bms_pack2 client=mb slave=pace_bms_pack2
#/protocol/modbus/device add id=cabin_main_meter client=mb slave=cabin_main_meter

# Tesla TWCs
#/protocol/tesla/twc/device/add id=carport_twc slave-id=0x6914
/protocol/tesla/twc/device/add id=shed_twc slave-id=0x6820

# CAN devices (BMS)
/protocol/can/device add id=house_bms interface=goodwe_can profile=pylon

# MQTT devices
/protocol/mqtt/device add id=annex_univ_gpo broker=mqtt profile=open_beken device_id=obk68B4AF26

#------------------------------------------------------------------------------------------
# Configure energy manager
/apps/energy/circuit add name=main meter=se_meter.meter max-current=63 type=single_phase meter-phase=1
/apps/energy/circuit add name=house parent=main max-current=50
/apps/energy/circuit add name=house.backup parent=house meter=goodwe_ems.inverter.backup max-current=50
/apps/energy/circuit add name=house.gpo parent=house.backup max-current=20
/apps/energy/circuit add name=house.lights parent=house.backup max-current=10
/apps/energy/circuit add name=annex.gpo parent=house.backup max-current=20
/apps/energy/circuit add name=annex.lights parent=house.backup max-current=10
/apps/energy/circuit add name=shed parent=house max-current=50
/apps/energy/circuit add name=carport parent=main max-current=32
/apps/energy/circuit add name=cabin parent=main meter=cabin_solar.inverter.export_meter max-current=20
/apps/energy/circuit add name=cabin.backup parent=cabin meter=cabin_solar.inverter.backup max-current=20
/apps/energy/circuit add name=cabin.gpo1 parent=cabin.backup max-current=20
/apps/energy/circuit add name=cabin.gpo2 parent=cabin.backup max-current=20
/apps/energy/circuit add name=cabin.laundry parent=cabin max-current=20
/apps/energy/circuit add name=cabin.carport parent=cabin max-current=50
/apps/energy/circuit add name=caravan parent=cabin.carport max-current=20

/apps/energy/appliance add id=solaredge circuit=house type=inverter
/apps/energy/appliance add id=goodwe circuit=house device=goodwe_ems priority=1
/apps/energy/appliance add id=cabin_solar circuit=cabin device=cabin_solar priority=1
/apps/energy/appliance add id=carport_evse circuit=carport device=carport_twc priority=5
/apps/energy/appliance add id=shed_evse circuit=shed device=shed_twc priority=5
/apps/energy/appliance add id=cabin_evse circuit=cabin.carport type=evse priority=5
/apps/energy/appliance add id=house_ac circuit=house type=hvac
/apps/energy/appliance add id=cabin_ac circuit=cabin.backup type=hvac
/apps/energy/appliance add id=cabin_hot_water circuit=cabin.laundry type=water-heater priority=6
/apps/energy/appliance add id=annex_univ_gpo circuit=annex.gpo device=annex_univ_gpo priority=7

/apps/energy/appliance add id=evie name=Evie type=car vin=LRW3F7EKXMC392131 priority=3
/apps/energy/appliance add id=zephyr name=Zephyr type=car vin=5YJ3F7EC8LF488644 priority=2
/apps/energy/appliance add id=mg_zs type=car circuit=cabin.carport priority=4 # we can't read the vin for this yet...

#/apps/energy/management/strategy add

#------------------------------------------------------------------------------------------
# Other runtime stuff

/protocol/http/server add name=webserver port=8080
/protocol/telnet/server add name=console port=23
/protocol/dns/server add name=dns protocols=mdns#,llmnr,wins,dns,dot,doh doh-server=webserver doh-uri=/dns-query

/protocol/websocket/server add name=websock http-server=webserver uri=/ws
/apps/api add name=api http-server=webserver uri=/api
/tools/pcap/server add name=rpcap port=2002 allow-anonymous=true
