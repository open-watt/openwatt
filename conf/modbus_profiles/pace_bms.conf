#
# Legend:
#
# reg: number (40000), type (u16), units (10mAh)
#	desc: id, display_units, sample_frequency, user_description
#	valueid: val0, val1, ...
#	valuedesc: "Value 0", "Value 1", ...
#	map-local: device.component.element
#	map-mb: server_name, register_number_or_id
#

#
# PACE "Household Energy" BMS:
#  http://www.pacebms.com/en/index.php/lists/33.html
#  https://raw.githubusercontent.com/syssi/esphome-pace-bms/main/docs/PACE-BMS-Modbus-Protocol-for-RS485-V1.3-20170627.pdf
#

enum: WarningFlags
	cell_ov: 0, "Cell Overvoltage"
	cell_uv: 1, "Cell Voltage Low"
	pack_ov: 2, "Pack Overvoltage"
	pack_uv: 3, "Pack Voltage Low"
	charge_oc: 4, "Charging Overcurrent"
	discharge_oc: 5, "Discharging Overcurrent"
	charge_ot: 8, "Charging Temp High"
	discharge_ot: 9, "Discharging Temp High"
	charge_ut: 10, "Charging Temp Low"
	discharge_ut: 11, "Discharging Temp Low"
	env_ot: 12, "Environment Temp High"
	env_ut: 13, "Environment Temp Low"
	mosfet_ot: 14, "MOSFET Temp High"
	soc_low: 15, "SOC Low"

enum: ProtectionFlags
	cell_ov_protect: 0, "Cell Overvoltage"
	cell_lv_protect: 1, "Cell Voltage Low"
	pack_ov_protect: 2, "Pack Overvoltage"
	pack_uv_protect: 3, "Pack Voltage Low"
	charge_oc_protect: 4, "Charging Overcurrent"
	discharge_oc_protect: 5, "Discharging Overcurrent"
	short_circuit_protect: 6, "Short Circuit"
	charger_ov_protect: 7, "Charger Overvoltage"
	charge_ot_protect: 8, "Charging Temp High"
	discharge_ot_protect: 9, "Discharging Temp High"
	charge_ut_protect: 10, "Charging Temp Low"
	discharge_ut_protect: 11, "Discharging Temp Low"
	mosfet_ot_protect: 12, "MOSFET Temp High"
	env_ot_protect: 13, "Environment Temp High"
	env_ut_protect: 14, "Environment Temp Low"

enum: StatusFaultFlags
	charge_mosfet_fault: 0, "Charging MOSFET Fault"
	discharge_mosfet_fault: 1, "Discharging MOSFET Fault"
	temp_sensor_fault: 2, "Temperature Sensor Fault"
	cell_fault: 4, "Battery Cell Fault"
	sampling_comm_fault: 5, "Front End Sampling Communication Fault"
	charging: 8, "Charging"
	discharging: 9, "Discharging"
	charg_mosfet_on: 10, "Charging MOSFET On"
	discharge_mosfet_on: 11, "Discharging MOSFET On"
	charging_limiter_on: 12, "Charging Limiter On"
	charger_inversed: 14, "Charger Inversed"
	heater_on: 15, "Heater On"

enum: BalanceStatus
	cell_balance_1: 0, "Balancing cell 1"
	cell_balance_2: 1, "Balancing cell 2"
	cell_balance_3: 2, "Balancing cell 3"
	cell_balance_4: 3, "Balancing cell 4"
	cell_balance_5: 4, "Balancing cell 5"
	cell_balance_6: 5, "Balancing cell 6"
	cell_balance_7: 6, "Balancing cell 7"
	cell_balance_8: 7, "Balancing cell 8"
	cell_balance_9: 8, "Balancing cell 9"
	cell_balance_10: 9, "Balancing cell 10"
	cell_balance_11: 10, "Balancing cell 11"
	cell_balance_12: 11, "Balancing cell 12"
	cell_balance_13: 12, "Balancing cell 13"
	cell_balance_14: 13, "Balancing cell 14"
	cell_balance_15: 14, "Balancing cell 15"
	cell_balance_16: 15, "Balancing cell 16"


registers:
	# data regs
	reg: 40000, i16, 10mA,		desc: current
	reg: 40001, u16, 10mV,		desc: packVoltage
	reg: 40002, u16, %,			desc: stateOfCharge
	reg: 40003, u16, %,			desc: stateOfHealth
	reg: 40004, u16, 10mAh,		desc: remainCapacity
	reg: 40005, u16, 10mAh,		desc: fullCapacity
	reg: 40006, u16, 10mAh,		desc: designCapacity
	reg: 40007, u16,			desc: cycleCounts
	reg: 40009, bf16, WarningFlags		desc: warningFlag
	reg: 40010, bf16, ProtectionFlags	desc: protectionFlag
	reg: 40011, bf16, StatusFaultFlags	desc: statusFaultFlag
	reg: 40012, bf16, BalanceStatus		desc: balanceStatus
	reg: 40015, u16, mV,		desc: cellVoltage1
	reg: 40016, u16, mV,		desc: cellVoltage2
	reg: 40017, u16, mV,		desc: cellVoltage3
	reg: 40018, u16, mV,		desc: cellVoltage4
	reg: 40019, u16, mV,		desc: cellVoltage5
	reg: 40020, u16, mV,		desc: cellVoltage6
	reg: 40021, u16, mV,		desc: cellVoltage7
	reg: 40022, u16, mV,		desc: cellVoltage8
	reg: 40023, u16, mV,		desc: cellVoltage9
	reg: 40024, u16, mV,		desc: cellVoltage10
	reg: 40025, u16, mV,		desc: cellVoltage11
	reg: 40026, u16, mV,		desc: cellVoltage12
	reg: 40027, u16, mV,		desc: cellVoltage13
	reg: 40028, u16, mV,		desc: cellVoltage14
	reg: 40029, u16, mV,		desc: cellVoltage15
	reg: 40030, u16, mV,		desc: cellVoltage16
	reg: 40031, i16, 0.1°C,		desc: cellTemp1
	reg: 40032, i16, 0.1°C,		desc: cellTemp2
	reg: 40033, i16, 0.1°C,		desc: cellTemp3
	reg: 40034, i16, 0.1°C,		desc: cellTemp4
	reg: 40035, i16, 0.1°C,		desc: mosfetTemp
	reg: 40036, i16, 0.1°C,		desc: envTemp

	# configuration
	reg: 40060, u16/RW, mV,		desc: packOVAlarm
	reg: 40061, u16/RW, mV,		desc: packOVProtection
	reg: 40062, u16/RW, mV,		desc: packOVRelease
	reg: 40063, u16/RW, 0.1s,	desc: packOVProtDelay
	reg: 40064, u16/RW, mV,		desc: cellOVAlarm
	reg: 40065, u16/RW, mV,		desc: cellOVProtection
	reg: 40066, u16/RW, mV,		desc: cellOVRelease
	reg: 40067, u16/RW, 0.1s,	desc: cellOVProtDelay
	reg: 40068, u16/RW, mV,		desc: packUVAlarm
	reg: 40069, u16/RW, mV,		desc: packUVProtection
	reg: 40070, u16/RW, mV,		desc: packUVRelease
	reg: 40071, u16/RW, 0.1s,	desc: packUVProtDelay
	reg: 40072, u16/RW, mV,		desc: cellUVAlarm
	reg: 40073, u16/RW, mV,		desc: cellUVProtection
	reg: 40074, u16/RW, mV,		desc: cellUVRelease
	reg: 40075, u16/RW, 0.1s,	desc: cellUVProtDelay
	reg: 40076, u16/RW, A,		desc: chargeOCAlarm
	reg: 40077, u16/RW, A,		desc: chargeOCProtection
	reg: 40078, u16/RW, 0.1s,	desc: chargeOCProtDelay
	reg: 40079, u16/RW, A,		desc: dischargeOCAlarm
	reg: 40080, u16/RW, A,		desc: dischargeOCProtection
	reg: 40081, u16/RW, 0.1s,	desc: dischargeOCProtDelay
	reg: 40082, u16/RW, A,		desc: dischargeOC2Protection
	reg: 40083, u16/RW, 0.025s,	desc: dischargeOC2ProtDelay
	reg: 40084, i16/RW, 0.1°C,	desc: chargeOTAlarm
	reg: 40085, i16/RW, 0.1°C,	desc: chargeOTProtection
	reg: 40086, i16/RW, 0.1°C,	desc: chargeOTRelease
	reg: 40087, i16/RW, 0.1°C,	desc: dischargeOTAlarm
	reg: 40088, i16/RW, 0.1°C,	desc: dischargeOTProtection
	reg: 40089, i16/RW, 0.1°C,	desc: dischargeOTRelease
	reg: 40090, i16/RW, 0.1°C,	desc: chargeUTAlarm
	reg: 40091, i16/RW, 0.1°C,	desc: chargeUTProtection
	reg: 40092, i16/RW, 0.1°C,	desc: chargeUTRelease
	reg: 40093, i16/RW, 0.1°C,	desc: dischargeUTAlarm
	reg: 40094, i16/RW, 0.1°C,	desc: dischargeUTProtection
	reg: 40095, i16/RW, 0.1°C,	desc: dischargeUTRelease
	reg: 40096, i16/RW, 0.1°C,	desc: mosfetOTAlarm
	reg: 40097, i16/RW, 0.1°C,	desc: mosfetOTProtection
	reg: 40098, i16/RW, 0.1°C,	desc: mosfetOTRelease
	reg: 40099, i16/RW, 0.1°C,	desc: envOTAlarm
	reg: 40100, i16/RW, 0.1°C,	desc: envOTProtection
	reg: 40101, i16/RW, 0.1°C,	desc: envOTRelease
	reg: 40102, i16/RW, 0.1°C,	desc: envUTAlarm
	reg: 40103, i16/RW, 0.1°C,	desc: envUTProtection
	reg: 40104, i16/RW, 0.1°C,	desc: envUTRelease
	reg: 40105, u16/RW, mV,		desc: balanceStartVoltage
	reg: 40106, u16/RW, mV,		desc: balanceStartDeltaVoltage
	reg: 40107, u16/RW, mV,		desc: packFullChargeVoltage
	reg: 40108, u16/RW, mA,		desc: packFullChargeCurrent
	reg: 40109, u16/RW, mV,		desc: cellSleepVoltage
	reg: 40110, u16/RW, min,	desc: cellSleepDelay
	reg: 40111, u16/RW, 25us,	desc: shortCircuitProtectDelay
	reg: 40112, u16/RW, %,		desc: socAlarmThreshold
	reg: 40113, u16/RW, A,		desc: chargeOC2Protection
	reg: 40114, u16/RW, 0.025s,	desc: chargeOC2ProtDelay

	# constants
	reg: 40150, str10,			desc: versionInfo
	reg: 40160, str10,			desc: modelSN
	reg: 40170, str10,			desc: packSN

device-template:
	component:
		id: info
		template: DeviceInfo
		element: type, "bms"
		element: name, "PACE BMS"
		element-map: model_id, @modelSN,				desc: , const, "Model Serial Number provided by BMS manufacturer"
		element-map: serial_number, @packSN,			desc: , const, "PACK Serial Number provided by PACK manufacturer"
		element-map: hardware_version, @versionInfo,	desc: , const, "Version information of the BMS"
	component:
		id: battery
		template: Battery
		element-map: soc, @stateOfCharge
		element-map: soh, @stateOfHealth
		element-map: remain_capacity, @remainCapacity
		element-map: full_capacity, @fullCapacity
		element-map: cycle_count, @cycleCounts
		element-map: cell_voltage1, @cellVoltage1,		desc: , realtime, "Cell 1 Voltage"
		element-map: cell_voltage2, @cellVoltage2,		desc: , realtime, "Cell 2 Voltage"
		element-map: cell_voltage3, @cellVoltage3,		desc: , realtime, "Cell 3 Voltage"
		element-map: cell_voltage4, @cellVoltage4,		desc: , realtime, "Cell 4 Voltage"
		element-map: cell_voltage5, @cellVoltage5,		desc: , realtime, "Cell 5 Voltage"
		element-map: cell_voltage6, @cellVoltage6,		desc: , realtime, "Cell 6 Voltage"
		element-map: cell_voltage7, @cellVoltage7,		desc: , realtime, "Cell 7 Voltage"
		element-map: cell_voltage8, @cellVoltage8,		desc: , realtime, "Cell 8 Voltage"
		element-map: cell_voltage9, @cellVoltage9,		desc: , realtime, "Cell 9 Voltage"
		element-map: cell_voltage10, @cellVoltage10,	desc: , realtime, "Cell 10 Voltage"
		element-map: cell_voltage11, @cellVoltage11,	desc: , realtime, "Cell 11 Voltage"
		element-map: cell_voltage12, @cellVoltage12,	desc: , realtime, "Cell 12 Voltage"
		element-map: cell_voltage13, @cellVoltage13,	desc: , realtime, "Cell 13 Voltage"
		element-map: cell_voltage14, @cellVoltage14,	desc: , realtime, "Cell 14 Voltage"
		element-map: cell_voltage15, @cellVoltage15,	desc: , realtime, "Cell 15 Voltage"
		element-map: cell_voltage16, @cellVoltage16,	desc: , realtime, "Cell 16 Voltage"
		element-map: balance_status, @balanceStatus,	desc: , high, "Balance Status", "Balancing status of the battery"
		element-map: cell_temp1, @cellTemp1,			desc: , low, "Cell Group 1 Temperature"
		element-map: cell_temp2, @cellTemp2,			desc: , low, "Cell Group 2 Temperature"
		element-map: cell_temp3, @cellTemp3,			desc: , low, "Cell Group 3 Temperature"
		element-map: cell_temp4, @cellTemp4,			desc: , low, "Cell Group 4 Temperature"
		element-map: mosfet_temp, @mosfetTemp
		element-map: env_temp, @envTemp
		element-map: warning_flag, @warningFlag
		element-map: protection_flag, @protectionFlag
		element-map: status_fault_flag, @statusFaultFlag
		component:
			id: config
			template: BatteryConfig
			element: topology, "16S1P"
			element: cell_count, 16
			element: cells_series, 16
			element: cells_parallel, 1
			element: cell_chemistry, "LiFePO4"
			element-map: design_capacity, @designCapacity
		component:
			id: realtime
			template: RealtimeEnergyMeter
			element: type, "dc"
			element-map: voltage, @packVoltage
			element-map: current, @current
			element: power, @battery.realtime.voltage * @battery.realtime.current
	component:
		id: config
		template: Configuration
		element-map: pack_full_charge_voltage, @packFullChargeVoltage,			desc: V, config, "Pack Full Charge Voltage"
		element-map: pack_full_charge_current, @packFullChargeCurrent,			desc: mA, config, "Pack Full Charge Current"
		element-map: balance_start_voltage, @balanceStartVoltage,				desc: V, config, "Balance Start Voltage"
		element-map: balance_start_delta_voltage, @balanceStartDeltaVoltage,	desc: mV, config, "Balance Start Delta Voltage"
		element-map: cell_sleep_voltage, @cellSleepVoltage,						desc: V, config, "Cell Sleep Voltage"
		element-map: cell_sleep_delay, @cellSleepDelay,							desc: min, config, "Cell Sleep Delay"
		element-map: soc_alarm_threshold, @socAlarmThreshold,					desc: %, config, "SOC Alarm Threshold"
		element-map: short_circuit_protect_delay, @shortCircuitProtectDelay,	desc: us, config, "Short Circuit Protect Delay", "Short circuit protect delay time (max 500us)"
		component:
			id: cell_ov
			template: Configuration
			element-map: alarm, @cellOVAlarm,			desc: V, config, "Alarm Threshold", "Cell Over Voltage alarm threshold"
			element-map: protection, @cellOVProtection,	desc: V, config, "Protection Threshold", "Cell Over Voltage protection threshold"
			element-map: release, @cellOVRelease,		desc: V, config, "Release Threshold", "Cell Over Voltage release protection threshold"
			element-map: prot_delay, @cellOVProtDelay,	desc: ms, config, "Protection Delay", "Cell Over Voltage protection delay time (1-255ms)"
		component:
			id: cell_uv
			template: Configuration
			element-map: alarm, @cellUVAlarm,			desc: V, config, "Alarm Threshold", "Cell Under Voltage alarm threshold"
			element-map: protection, @cellUVProtection,	desc: V, config, "Protection Threshold", "Cell Under Voltage protection threshold"
			element-map: release, @cellUVRelease,		desc: V, config, "Release Threshold", "Cell Under Voltage release protection threshold"
			element-map: prot_delay, @cellUVProtDelay,	desc: ms, config, "Protection Delay",  "Cell Under Voltage protection delay time (1-255ms)"
		component:
			id: pack_ov
			template: Configuration
			element-map: alarm, @packOVAlarm,			desc: V, config, "Alarm Threshold", "Pack Over Voltage alarm threshold"
			element-map: protection, @packOVProtection,	desc: V, config, "Protection Threshold", "Pack Over Voltage protection threshold"
			element-map: release, @packOVRelease,		desc: V, config, "Release Threshold", "Pack Over Voltage release protection threshold"
			element-map: prot_delay, @packOVProtDelay,	desc: ms, config, "Protection Delay", "Pack Over Voltage protection delay time (1-255ms)"
		component:
			id: pack_uv
			template: Configuration
			element-map: alarm, @packUVAlarm,			desc: V, config, "Alarm Threshold", "Pack Under Voltage alarm threshold"
			element-map: protection, @packUVProtection,	desc: V, config, "Protection Threshold", "Pack Under Voltage protection threshold"
			element-map: release, @packUVRelease,		desc: V, config, "Release Threshold", "Pack Under Voltage release protection threshold"
			element-map: prot_delay, @packUVProtDelay,	desc: ms, config, "Protection Delay", "Pack Under Voltage protection delay time (1-255ms)"
		component:
			id: charge
			template: Configuration
			element-map: oc_alarm, @chargeOCAlarm,				desc: A, config, "OC Alarm", "Charging Over Current alarm threshold"
			element-map: oc_protection, @chargeOCProtection,	desc: A, config, "OC Protection", "Charging Over Current protection threshold"
			element-map: oc_prot_delay, @chargeOCProtDelay,		desc: ms, config, "OC Protection Delay", "Charging Over Current protection delay time (1-255ms)"
			element-map: oc2_protection, @chargeOC2Protection,	desc: A, config, "OC2 Protection", "Charging Over Current 2 protection threshold"
			element-map: oc2_prot_delay, @chargeOC2ProtDelay,	desc: ms, config, "OC2 Protection Delay", "Charging Over Current 2 protection delay time (1-255ms)"
			element-map: ot_alarm, @chargeOTAlarm,				desc: °C, config, "OT Alarm", "Charging Over Temperature alarm threshold"
			element-map: ot_protection, @chargeOTProtection,	desc: °C, config, "OT Protection", "Charging Over Temperature protection threshold"
			element-map: ot_release, @chargeOTRelease,			desc: °C, config, "OT Release", "Charging Over Temperature release protection threshold"
			element-map: ut_alarm, @chargeUTAlarm,				desc: °C, config, "UT Alarm", "Charging Under Temperature alarm threshold"
			element-map: ut_protection, @chargeUTProtection,	desc: °C, config, "UT Protection", "Charging Under Temperature protection threshold"
			element-map: ut_release, @chargeUTRelease,			desc: °C, config, "UT Release", "Charging Under Temperature release protection threshold"
		component:
			id: discharge
			template: Configuration
			element-map: oc_alarm, @dischargeOCAlarm,				desc: A, config, "OC Alarm"
			element-map: oc_protection, @dischargeOCProtection,		desc: A, config, "OC Protection"
			element-map: oc_prot_delay, @dischargeOCProtDelay,		desc: ms, config, "OC Protection Delay", "1-255ms"
			element-map: oc2_protection, @dischargeOC2Protection,	desc: A, config, "OC2 Protection"
			element-map: oc2_prot_delay, @dischargeOC2ProtDelay,	desc: ms, config, "OC2 Protection Delay", "1-255ms"
			element-map: ot_alarm, @dischargeOTAlarm,				desc: °C, config, "OT Alarm", "Discharging Over Temperature alarm threshold"
			element-map: ot_protection, @dischargeOTProtection,		desc: °C, config, "OT Protection", "Discharging Over Temperature protection threshold"
			element-map: ot_release, @dischargeOTRelease,			desc: °C, config, "OT Release", "Discharging Over Temperature release protection threshold"
			element-map: ut_alarm, @dischargeUTAlarm,				desc: °C, config, "UT Alarm", "Discharging Under Temperature alarm threshold"
			element-map: ut_protection, @dischargeUTProtection,		desc: °C, config, "UT Protection", "Discharging Under Temperature protection threshold"
			element-map: ut_release, @dischargeUTRelease,			desc: °C, config, "UT Release", "Discharging Under Temperature release protection threshold"
		component:
			id: mosfet
			template: Configuration
			element-map: ot_alarm, @mosfetOTAlarm,				desc: °C, config, "OT Alarm", "MOSFET Over Temperature alarm threshold"
			element-map: ot_protection, @mosfetOTProtection,	desc: °C, config, "OT Protection", "MOSFET Over Temperature protection threshold"
			element-map: ot_release, @mosfetOTRelease,			desc: °C, config, "OT Release", "MOSFET Over Temperature release protection threshold"
		component:
			id: environment
			template: Configuration
			element-map: ot_alarm, @envOTAlarm,					desc: °C, config, "OT Alarm", "Environment Over Temperature alarm threshold"
			element-map: ot_protection, @envOTProtection,		desc: °C, config, "OT Protection", "Environment Over Temperature protection threshold"
			element-map: ot_release, @envOTRelease,				desc: °C, config, "OT Release", "Environment Over Temperature release protection threshold"
			element-map: ut_alarm, @envUTAlarm,					desc: °C, config, "UT Alarm", "Environment Under Temperature alarm threshold"
			element-map: ut_protection, @envUTProtection,		desc: °C, config, "UT Protection", "Environment Under Temperature protection threshold"
			element-map: ut_release, @envUTRelease,				desc: °C, config, "UT Release", "Environment Under Temperature release protection threshold"
