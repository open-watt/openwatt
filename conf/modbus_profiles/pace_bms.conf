#
# Legend:
#
# reg: number (40000), type (u16), units (10mAh)
#	desc: id, display_units, sample_frequency, user_description
#	valueid: val0, val1, ...
#	valuedesc: "Value 0", "Value 1", ...
#	map-local: device.component.element
#	map-mb: server_name, register_number_or_id
#

#
# PACE "Household Energy" BMS:
#  http://www.pacebms.com/en/index.php/lists/33.html
#  https://raw.githubusercontent.com/syssi/esphome-pace-bms/main/docs/PACE-BMS-Modbus-Protocol-for-RS485-V1.3-20170627.pdf
#

enum: WarningFlags
	cell_ov: 0, "Cell Overvoltage"
	cell_uv: 1, "Cell Voltage Low"
	pack_ov: 2, "Pack Overvoltage"
	pack_uv: 3, "Pack Voltage Low"
	charge_oc: 4, "Charging Overcurrent"
	discharge_oc: 5, "Discharging Overcurrent"
	charge_ot: 8, "Charging Temp High"
	discharge_ot: 9, "Discharging Temp High"
	charge_ut: 10, "Charging Temp Low"
	discharge_ut: 11, "Discharging Temp Low"
	env_ot: 12, "Environment Temp High"
	env_ut: 13, "Environment Temp Low"
	mosfet_ot: 14, "MOSFET Temp High"
	soc_low: 15, "SOC Low"

enum: ProtectionFlags
	cell_ov_protect: 0, "Cell Overvoltage"
	cell_lv_protect: 1, "Cell Voltage Low"
	pack_ov_protect: 2, "Pack Overvoltage"
	pack_uv_protect: 3, "Pack Voltage Low"
	charge_oc_protect: 4, "Charging Overcurrent"
	discharge_oc_protect: 5, "Discharging Overcurrent"
	short_circuit_protect: 6, "Short Circuit"
	charger_ov_protect: 7, "Charger Overvoltage"
	charge_ot_protect: 8, "Charging Temp High"
	discharge_ot_protect: 9, "Discharging Temp High"
	charge_ut_protect: 10, "Charging Temp Low"
	discharge_ut_protect: 11, "Discharging Temp Low"
	mosfet_ot_protect: 12, "MOSFET Temp High"
	env_ot_protect: 13, "Environment Temp High"
	env_ut_protect: 14, "Environment Temp Low"

enum: StatusFaultFlags
	charge_mosfet_fault: 0, "Charging MOSFET Fault"
	discharge_mosfet_fault: 1, "Discharging MOSFET Fault"
	temp_sensor_fault: 2, "Temperature Sensor Fault"
	cell_fault: 4, "Battery Cell Fault"
	sampling_comm_fault: 5, "Front End Sampling Communication Fault"
	charging: 8, "Charging"
	discharging: 9, "Discharging"
	charg_mosfet_on: 10, "Charging MOSFET On"
	discharge_mosfet_on: 11, "Discharging MOSFET On"
	charging_limiter_on: 12, "Charging Limiter On"
	charger_inversed: 14, "Charger Inversed"
	heater_on: 15, "Heater On"

enum: BalanceStatus
	cell_balance_1: 0, "Balancing cell 1"
	cell_balance_2: 1, "Balancing cell 2"
	cell_balance_3: 2, "Balancing cell 3"
	cell_balance_4: 3, "Balancing cell 4"
	cell_balance_5: 4, "Balancing cell 5"
	cell_balance_6: 5, "Balancing cell 6"
	cell_balance_7: 6, "Balancing cell 7"
	cell_balance_8: 7, "Balancing cell 8"
	cell_balance_9: 8, "Balancing cell 9"
	cell_balance_10: 9, "Balancing cell 10"
	cell_balance_11: 10, "Balancing cell 11"
	cell_balance_12: 11, "Balancing cell 12"
	cell_balance_13: 12, "Balancing cell 13"
	cell_balance_14: 13, "Balancing cell 14"
	cell_balance_15: 14, "Balancing cell 15"
	cell_balance_16: 15, "Balancing cell 16"


registers:
	# data regs
	reg: 40000, i16, 10mA,		desc: current, A, realtime, "Current flow. Positive: Charging, Negative: Discharging"
	reg: 40001, u16, 10mV,		desc: packVoltage, V, high, "Voltage of the pack"
	reg: 40002, u16, %,			desc: stateOfCharge, %, high, "State of Charge (SOC)"
	reg: 40003, u16, %,			desc: stateOfHealth, %, low, "State of Health (SOH)"
	reg: 40004, u16, 10mAh,		desc: remainCapacity, Ah, high, "Remaining battery capacity"
	reg: 40005, u16, 10mAh,		desc: fullCapacity, Ah, low, "Full battery capacity"
	reg: 40006, u16, 10mAh,		desc: designCapacity, Ah, const, "Design capacity of the battery"
	reg: 40007, u16,			desc: cycleCounts, , low, "Number of battery cycle counts"
	reg: 40009, bf16, WarningFlags		desc: warningFlag, , high, "Warning flags"
	reg: 40010, bf16, ProtectionFlags	desc: protectionFlag, , high, "Protection flags"
	reg: 40011, bf16, StatusFaultFlags	desc: statusFaultFlag, , high, "Status and fault flags"
	reg: 40012, bf16, BalanceStatus		desc: balanceStatus, , high, "Balance status of the battery"
	reg: 40015, u16, mV,		desc: cellVoltage1, V, high, "Voltage of cell 1"
	reg: 40016, u16, mV,		desc: cellVoltage2, V, high, "Voltage of cell 2"
	reg: 40017, u16, mV,		desc: cellVoltage3, V, high, "Voltage of cell 3"
	reg: 40018, u16, mV,		desc: cellVoltage4, V, high, "Voltage of cell 4"
	reg: 40019, u16, mV,		desc: cellVoltage5, V, high, "Voltage of cell 5"
	reg: 40020, u16, mV,		desc: cellVoltage6, V, high, "Voltage of cell 6"
	reg: 40021, u16, mV,		desc: cellVoltage7, V, high, "Voltage of cell 7"
	reg: 40022, u16, mV,		desc: cellVoltage8, V, high, "Voltage of cell 8"
	reg: 40023, u16, mV,		desc: cellVoltage9, V, high, "Voltage of cell 9"
	reg: 40024, u16, mV,		desc: cellVoltage10, V, high, "Voltage of cell 10"
	reg: 40025, u16, mV,		desc: cellVoltage11, V, high, "Voltage of cell 11"
	reg: 40026, u16, mV,		desc: cellVoltage12, V, high, "Voltage of cell 12"
	reg: 40027, u16, mV,		desc: cellVoltage13, V, high, "Voltage of cell 13"
	reg: 40028, u16, mV,		desc: cellVoltage14, V, high, "Voltage of cell 14"
	reg: 40029, u16, mV,		desc: cellVoltage15, V, high, "Voltage of cell 15"
	reg: 40030, u16, mV,		desc: cellVoltage16, V, high, "Voltage of cell 16"
	reg: 40031, i16, 0.1°C,		desc: cellTemp1, °, medium, "Temperature of cell 1"
	reg: 40032, i16, 0.1°C,		desc: cellTemp2, °, medium, "Temperature of cell 2"
	reg: 40033, i16, 0.1°C,		desc: cellTemp3, °, medium, "Temperature of cell 3"
	reg: 40034, i16, 0.1°C,		desc: cellTemp4, °, medium, "Temperature of cell 4"
	reg: 40035, i16, 0.1°C,		desc: mosfetTemp, °, medium, "MOSFET temperature or invalid if not applicable"
	reg: 40036, i16, 0.1°C,		desc: envTemp, °, medium, "Environment temperature or invalid if not applicable"

	# configuration
	reg: 40060, u16/RW, mV,		desc: packOVAlarm, V, config, "Pack Over Voltage alarm threshold"
	reg: 40061, u16/RW, mV,		desc: packOVProtection, V, config, "Pack Over Voltage protection threshold"
	reg: 40062, u16/RW, mV,		desc: packOVRelease, V, config, "Pack Over Voltage release protection threshold"
	reg: 40063, u16/RW, 0.1s,	desc: packOVProtDelay, ms, config, "Pack Over Voltage protection delay time (1-255)"
	reg: 40064, u16/RW, mV,		desc: cellOVAlarm, V, config, "Cell Over Voltage alarm threshold"
	reg: 40065, u16/RW, mV,		desc: cellOVProtection, V, config, "Cell Over Voltage protection threshold"
	reg: 40066, u16/RW, mV,		desc: cellOVRelease, V, config, "Cell Over Voltage release protection threshold"
	reg: 40067, u16/RW, 0.1s,	desc: cellOVProtDelay, ms, config, "Cell Over Voltage protection delay time (1-255)"
	reg: 40068, u16/RW, mV,		desc: packUVAlarm, V, config, "Pack Under Voltage alarm threshold"
	reg: 40069, u16/RW, mV,		desc: packUVProtection, V, config, "Pack Under Voltage protection threshold"
	reg: 40070, u16/RW, mV,		desc: packUVRelease, V, config, "Pack Under Voltage release protection threshold"
	reg: 40071, u16/RW, 0.1s,	desc: packUVProtDelay, ms, config, "Pack Under Voltage protection delay time (1-255)"
	reg: 40072, u16/RW, mV,		desc: cellUVAlarm, V, config, "Cell Under Voltage alarm threshold"
	reg: 40073, u16/RW, mV,		desc: cellUVProtection, V, config, "Cell Under Voltage protection threshold"
	reg: 40074, u16/RW, mV,		desc: cellUVRelease, V, config, "Cell Under Voltage release protection threshold"
	reg: 40075, u16/RW, 0.1s,	desc: cellUVProtDelay, ms, config, "Cell Under Voltage protection delay time (1-255)"
	reg: 40076, u16/RW, A,		desc: chargeOCAlarm, A, config, "Charging Over Current alarm threshold"
	reg: 40077, u16/RW, A,		desc: chargeOCProtection, A, config, "Charging Over Current protection threshold"
	reg: 40078, u16/RW, 0.1s,	desc: chargeOCProtDelay, ms, config, "Charging Over Current protection delay time (1-255)"
	reg: 40079, u16/RW, A,		desc: dischargeOCAlarm, A, config, "Discharging Over Current alarm threshold"
	reg: 40080, u16/RW, A,		desc: dischargeOCProtection, A, config, "Discharging Over Current protection threshold"
	reg: 40081, u16/RW, 0.1s,	desc: dischargeOCProtDelay, ms, config, "Discharging Over Current protection delay time (1-255)"
	reg: 40082, u16/RW, A,		desc: dischargeOC2Protection, A, config, "Discharging Over Current 2 protection threshold"
	reg: 40083, u16/RW, 0.025s,	desc: dischargeOC2ProtDelay, ms, config, "Discharging Over Current 2 protection delay time (1-255)"
	reg: 40084, i16/RW, 0.1°C,	desc: chargeOTAlarm, °C, config, "Charging Over Temperature alarm threshold"
	reg: 40085, i16/RW, 0.1°C,	desc: chargeOTProtection, °C, config, "Charging Over Temperature protection threshold"
	reg: 40086, i16/RW, 0.1°C,	desc: chargeOTRelease, °C, config, "Charging Over Temperature release protection threshold"
	reg: 40087, i16/RW, 0.1°C,	desc: dischargeOTAlarm, °C, config, "Discharging Over Temperature alarm threshold"
	reg: 40088, i16/RW, 0.1°C,	desc: dischargeOTProtection, °C, config, "Discharging Over Temperature protection threshold"
	reg: 40089, i16/RW, 0.1°C,	desc: dischargeOTRelease, °C, config, "Discharging Over Temperature release protection threshold"
	reg: 40090, i16/RW, 0.1°C,	desc: chargeUTAlarm, °C, config, "Charging Under Temperature alarm threshold"
	reg: 40091, i16/RW, 0.1°C,	desc: chargeUTProtection, °C, config, "Charging Under Temperature protection threshold"
	reg: 40092, i16/RW, 0.1°C,	desc: chargeUTRelease, °C, config, "Charging Under Temperature release protection threshold"
	reg: 40093, i16/RW, 0.1°C,	desc: dischargeUTAlarm, °C, config, "Discharging Under Temperature alarm threshold"
	reg: 40094, i16/RW, 0.1°C,	desc: dischargeUTProtection, °C, config, "Discharging Under Temperature protection threshold"
	reg: 40095, i16/RW, 0.1°C,	desc: dischargeUTRelease, °C, config, "Discharging Under Temperature release protection threshold"
	reg: 40096, i16/RW, 0.1°C,	desc: mosfetOTAlarm, °C, config, "MOSFET Over Temperature alarm threshold"
	reg: 40097, i16/RW, 0.1°C,	desc: mosfetOTProtection, °C, config, "MOSFET Over Temperature protection threshold"
	reg: 40098, i16/RW, 0.1°C,	desc: mosfetOTRelease, °C, config, "MOSFET Over Temperature release protection threshold"
	reg: 40099, i16/RW, 0.1°C,	desc: envOTAlarm, °C, config, "Environment Over Temperature alarm threshold"
	reg: 40100, i16/RW, 0.1°C,	desc: envOTProtection, °C, config, "Environment Over Temperature protection threshold"
	reg: 40101, i16/RW, 0.1°C,	desc: envOTRelease, °C, config, "Environment Over Temperature release protection threshold"
	reg: 40102, i16/RW, 0.1°C,	desc: envUTAlarm, °C, config, "Environment Under Temperature alarm threshold"
	reg: 40103, i16/RW, 0.1°C,	desc: envUTProtection, °C, config, "Environment Under Temperature protection threshold"
	reg: 40104, i16/RW, 0.1°C,	desc: envUTRelease, °C, config, "Environment Under Temperature release protection threshold"
	reg: 40105, u16/RW, mV,		desc: balanceStartVoltage, V, config, "Balance start cell voltage"
	reg: 40106, u16/RW, mV,		desc: balanceStartDeltaVoltage, mV, config, "Balance start delta voltage"
	reg: 40107, u16/RW, mV,		desc: packFullChargeVoltage, V, config, "Pack full-charge voltage"
	reg: 40108, u16/RW, mA,		desc: packFullChargeCurrent, mA, config, "Pack full-charge current"
	reg: 40109, u16/RW, mV,		desc: cellSleepVoltage, V, config, "Cell sleep voltage"
	reg: 40110, u16/RW, min,	desc: cellSleepDelay, min, config, "Cell sleep delay time"
	reg: 40111, u16/RW, 25us,	desc: shortCircuitProtectDelay, us, config, "Short circuit protect delay time (max 500uS)"
	reg: 40112, u16/RW, %,		desc: socAlarmThreshold, %, config, "SOC alarm threshold"
	reg: 40113, u16/RW, A,		desc: chargeOC2Protection, A, config, "Charging Over Current 2 protection threshold"
	reg: 40114, u16/RW, 0.025s,	desc: chargeOC2ProtDelay, ms, config, "Charging Over Current 2 protection delay time (1-255)"

	# constants
	reg: 40150, str10,			desc: versionInfo, , const, "Version information of the BMS"
	reg: 40160, str10,			desc: modelSN, , const, "Model Serial Number provided by BMS manufacturer"
	reg: 40170, str10,			desc: packSN, , const, "PACK Serial Number provided by PACK manufacturer"

device-template:
	component:
		id: info
		template: DeviceInfo
		element: type, "bms"
		element: name, "PACE BMS"
		element-map: model_number, @modelSN
		element-map: serial_number, @packSN
		element-map: hardware_version, @versionInfo
	component:
		id: battery
		template: battery
		element-map: soc, @stateOfCharge
		element-map: soh, @stateOfHealth
		element-map: remain_capacity, @remainCapacity
		element-map: full_capacity, @fullCapacity
		element-map: cycle_count, @cycleCounts
		element-map: cell_voltage_1, @cellVoltage1
		element-map: cell_voltage_2, @cellVoltage2
		element-map: cell_voltage_3, @cellVoltage3
		element-map: cell_voltage_4, @cellVoltage4
		element-map: cell_voltage_5, @cellVoltage5
		element-map: cell_voltage_6, @cellVoltage6
		element-map: cell_voltage_7, @cellVoltage7
		element-map: cell_voltage_8, @cellVoltage8
		element-map: cell_voltage_9, @cellVoltage9
		element-map: cell_voltage_10, @cellVoltage10
		element-map: cell_voltage_11, @cellVoltage11
		element-map: cell_voltage_12, @cellVoltage12
		element-map: cell_voltage_13, @cellVoltage13
		element-map: cell_voltage_14, @cellVoltage14
		element-map: cell_voltage_15, @cellVoltage15
		element-map: cell_voltage_16, @cellVoltage16
		element-map: balance_status, @balanceStatus
		element-map: cell_temp_1, @cellTemp1
		element-map: cell_temp_2, @cellTemp2
		element-map: cell_temp_3, @cellTemp3
		element-map: cell_temp_4, @cellTemp4
		element-map: mosfet_temp, @mosfetTemp
		element-map: env_temp, @envTemp
		element-map: warning_flag, @warningFlag
		element-map: protection_flag, @protectionFlag
		element-map: status_fault_flag, @statusFaultFlag
		component:
			id: config
			template: BatteryConfig
			element: topology, "16S1P"
			element: cell_count, 16
			element: cells_series, 16
			element: cells_parallel, 1
			element: cell_chemistry, "LiFePO4"
			element_map: design_capacity, @designCapacity
		component:
			id: realtime
			template: RealtimeEnergyMeter
			element: type, "dc"
			element-map: voltage, @packVoltage
			element-map: current, @current
	component:
		id: config
		template: Configuration
		element-map: pack_full_charge_voltage, @packFullChargeVoltage
		element-map: pack_full_charge_current, @packFullChargeCurrent
		element-map: balance_start_voltage, @balanceStartVoltage
		element-map: balance_start_delta_voltage, @balanceStartDeltaVoltage
		element-map: cell_sleep_voltage, @cellSleepVoltage
		element-map: cell_sleep_delay, @cellSleepDelay
		element-map: soc_alarm_threshold, @socAlarmThreshold
		element-map: short_circuit_protect_delay, @shortCircuitProtectDelay
		component:
			id: cell_ov
			template: Configuration
			element-map: alarm, @cellOVAlarm
			element-map: protection, @cellOVProtection
			element-map: release, @cellOVRelease
			element-map: prot_delay, @cellOVProtDelay
		component:
			id: cell_uv
			template: Configuration
			element-map: alarm, @cellUVAlarm
			element-map: protection, @cellUVProtection
			element-map: release, @cellUVRelease
			element-map: prot_delay, @cellUVProtDelay
		component:
			id: pack_ov
			template: Configuration
			element-map: alarm, @packOVAlarm
			element-map: protection, @packOVProtection
			element-map: release, @packOVRelease
			element-map: prot_delay, @packOVProtDelay
		component:
			id: pack_uv
			template: Configuration
			element-map: alarm, @packUVAlarm
			element-map: protection, @packUVProtection
			element-map: release, @packUVRelease
			element-map: prot_delay, @packUVProtDelay
		component:
			id: charge
			template: Configuration
			element-map: oc_alarm, @chargeOCAlarm
			element-map: oc_protection, @chargeOCProtection
			element-map: oc_prot_delay, @chargeOCProtDelay
			element-map: oc2_protection, @chargeOC2Protection
			element-map: oc2_prot_delay, @chargeOC2ProtDelay
			element-map: ot_alarm, @chargeOTAlarm
			element-map: ot_protection, @chargeOTProtection
			element-map: ot_release, @chargeOTRelease
			element-map: ut_alarm, @chargeUTAlarm
			element-map: ut_protection, @chargeUTProtection
			element-map: ut_release, @chargeUTRelease
		component:
			id: discharge
			template: Configuration
			element-map: oc_alarm, @dischargeOCAlarm
			element-map: oc_protection, @dischargeOCProtection
			element-map: oc_prot_delay, @dischargeOCProtDelay
			element-map: oc2_protection, @dischargeOC2Protection
			element-map: oc2_prot_delay, @dischargeOC2ProtDelay
			element-map: ot_alarm, @dischargeOTAlarm
			element-map: ot_protection, @dischargeOTProtection
			element-map: ot_release, @dischargeOTRelease
			element-map: ut_alarm, @dischargeUTAlarm
			element-map: ut_protection, @dischargeUTProtection
			element-map: ut_release, @dischargeUTRelease
		component:
			id: mosfet
			template: Configuration
			element-map: ot_alarm, @mosfetOTAlarm
			element-map: ot_protection, @mosfetOTProtection
			element-map: ot_release, @mosfetOTRelease
		component:
			id: environment
			template: Configuration
			element-map: ot_alarm, @envOTAlarm
			element-map: ot_protection, @envOTProtection
			element-map: ot_release, @envOTRelease
			element-map: ut_alarm, @envUTAlarm
			element-map: ut_protection, @envUTProtection
			element-map: ut_release, @envUTRelease
