#
# Legend:
#
# reg: number (40000), type (u16), units (10mAh)
#	desc: id, display_units, sample_frequency, user_description
#	valueid: val0, val1, ...
#	valuedesc: "Value 0", "Value 1", ...
#	map-local: device.component.element
#	map-mb: server_name, register_number_or_id
#

#
# SmartEVSE:
#  https://github.com/SmartEVSE/SmartEVSE-2?tab=readme-ov-file#modbus
#
#
#  Predefined electric meters:
#    1: Sensorbox
#    2: PHOENIX CONTACT EEM-350-D-MCB
#    3: Finder 7E.78.8.400.0212
#    4: Eastron SDM630
#    5: ABB B23 212-100
#    6: SolarEdge SunSpec
#    7: WAGO 879-30x0
#    8: Finder 7M.38.8.400.0212
#    9: Custom
#

enum: State
	a: 0, "A"
	b: 1, "B"
	c: 2, "C"
	d: 3, "D"
	node_req_b: 4, "Node request B"
	master_confirm_b: 5, "Master confirm B"
	node_req_c: 6, "Node request C"
	master_confirm_c: 7, "Master confirm C"
	activation_mode: 8, "Activation mode"
	b1: 9, "B1"
	c1: 10, "C1"

enum: ErrorFlags
	less_6a: 0, "Less than 6A"
	no_comm: 1, "No Communication"
	temp_high: 2, "Temperature High"
	rcd: 4, "RCD"
	no_sun: 5, "No Sun"

enum: Mode
	normal: 0, "Normal"
	smart: 1, "Smart"
	solar: 2, "Solar"

enum: CableConfig
	socket: 0, "Socket"
	fixed_cable: 1, "Fixed Cable"

enum: CableLock
	disabled: 0, "Disable"
	solenoid: 1, "Solenoid"
	motor: 2, "Motor"

enum: LoadBalance
	disabled: 0, "Disabled"
	master: 1, "Master"
	node2: 2, "Node2"
	node3: 3, "Node3"
	node4: 4, "Node4"
	node5: 5, "Node5"
	node6: 6, "Node6"
	node7: 7, "Node7"
	node8: 8, "Node8"

enum: ExternalSwitchMode
	normal: 0, "Normal"
	access_push_button: 1, "Access Push-Button"
	access_switch: 2, "Access Switch"
	smart_solar_push_button: 3, "Smart-Solar Push-Button"
	smart_solar_switch: 4, "Smart-Solar Switch"

enum: EnableDisable
	disabled: 0, "Disabled"
	enabled: 1, "Enabled"

enum: MeterType
	sensorbox: 1, "Sensorbox"
	phoenix_contact_eem_350_d_mcb: 2, "PHOENIX CONTACT EEM-350-D-MCB"
	finder_7E_78_8_400_0212: 3, "Finder 7E.78.8.400.0212"
	eastron_sdm630: 4, "Eastron SDM630"
	abb_b23_212_100: 5, "ABB B23 212-100"
	solaredge_sunspec: 6, "SolarEdge SunSpec"
	wago_879_30x0: 7, "WAGO 879-30x0"
	finder_7M_38_8_400_0212: 8, "Finder 7M.38.8.400.0212"
	custom: 9, "Custom"

enum: GridType
	_4_wire: 0, "4 Wire"
	_3_wire: 1, "3 Wire"

enum: MainsMeterMeasure
	mains: 0, "Mains (Home+EVSE+PV)"
	ex_solar: 1, "Excluding solar (Home+EVSE)"

enum: CustomMeterByteOrder
	lbf_lwf: 0, "LBF & LWF"
	lbf_hwf: 1, "LBF & HWF"
	hbf_lwf: 2, "HBF & LWF"
	hbf_hwf: 3, "HBF & HWF"

enum: CustomMeterDataType
	integer: 0, "Integer"
	float: 1, "Float"


registers:
	# EVSE Status
	reg: 40000, enum16/RW, State,		desc: state
	reg: 40001, bf16/RW, ErrorFlags,	desc: error
	reg: 40002, u16/RW,	0.1A,			desc: chargeCurrent
	reg: 40003, enum16/RW, Mode,		desc: modeNoSave, , high, "EVSE mode (without saving)"
	reg: 40004, u16/RW, s,				desc: solarTimer, s, high, "Solar Timer"
	reg: 40005, u16/RW,					desc: accessBit, , high, "Access bit [0:No Access, 1:Access]"
	reg: 40006, u16/RW,					desc: configChanged, , high, "Configuration changed (Not implemented)"
	reg: 40007, u16, A,					desc: maxChargeCurrent
	reg: 40008, u16/RW,					desc: numUsedPhases, , high, "Number of used phases (Not implemented) [0:Undetected, 1 - 3]"
	reg: 40009, u16, 0.1A,				desc: realChargeCurrent, A, realtime, "Real charging current (Not implemented)"
	reg: 40010, u16, °C,				desc: temp
	reg: 40011, u16,					desc: sn
	reg: 40032, u16/W, 0.1A,			desc: broadcastChargeCurrent0, A, config, "Broadcast charge current. SmartEVSE uses only one value depending on the 'Load Balancing' configuration"
	reg: 40033, u16/W, 0.1A,			desc: broadcastChargeCurrent1, A, config, "Broadcast charge current. SmartEVSE uses only one value depending on the 'Load Balancing' configuration"
	reg: 40034, u16/W, 0.1A,			desc: broadcastChargeCurrent2, A, config, "Broadcast charge current. SmartEVSE uses only one value depending on the 'Load Balancing' configuration"
	reg: 40035, u16/W, 0.1A,			desc: broadcastChargeCurrent3, A, config, "Broadcast charge current. SmartEVSE uses only one value depending on the 'Load Balancing' configuration"
	reg: 40036, u16/W, 0.1A,			desc: broadcastChargeCurrent4, A, config, "Broadcast charge current. SmartEVSE uses only one value depending on the 'Load Balancing' configuration"
	reg: 40037, u16/W, 0.1A,			desc: broadcastChargeCurrent5, A, config, "Broadcast charge current. SmartEVSE uses only one value depending on the 'Load Balancing' configuration"
	reg: 40038, u16/W, 0.1A,			desc: broadcastChargeCurrent6, A, config, "Broadcast charge current. SmartEVSE uses only one value depending on the 'Load Balancing' configuration"
	reg: 40039, u16/W, 0.1A,			desc: broadcastChargeCurrent7, A, config, "Broadcast charge current. SmartEVSE uses only one value depending on the 'Load Balancing' configuration"

	# Node specific configuration
	reg: 40100, enum16/RW, CableConfig,			desc: cableConfig
	reg: 40101, enum16/RW, CableLock,			desc: cableLock
	reg: 40102, u16/RW, A,						desc: minChargeCurrent
	reg: 40103, u16/RW, A,						desc: maxChargeCurrent
	reg: 40104, enum16/RW, LoadBalance,			desc: loadBalance
	reg: 40105, enum16/RW, ExternalSwitchMode,	desc: externalSwitchMode
	reg: 40106, enum16/RW, EnableDisable,		desc: rcm
	reg: 40107, enum16/RW, EnableDisable,		desc: useRfid
	reg: 40108, enum16/RW, MeterType,			desc: meterType
	reg: 40109, u16/RW,							desc: meterAddress

	# System configuration (same on all SmartEVSE in a LoadBalancing setup)
	reg: 40200, enum16/RW, Mode,					desc: mode
	reg: 40201, u16/RW, A,							desc: maxCircuitCurrent
	reg: 40202, enum16/RW, GridType,				desc: gridType
	reg: 40203, u16/RW, 0.01,						desc: ctCalibration
	reg: 40204, u16/RW, A,							desc: maxMainsCurrent
	reg: 40205, u16/RW, A,							desc: surplusEnergyStartCurrent
	reg: 40206, u16/RW, min,						desc: stopSolarAfter
	reg: 40207, u16/RW, A,							desc: allowGridPower
	reg: 40208, enum16/RW, MeterType,				desc: mainsMeterType
	reg: 40209, u16/RW,								desc: mainsMeterAddress
	reg: 40210, enum16/RW, MainsMeterMeasure,		desc: mainsMeterMeasure
	reg: 40211, enum16/RW, MeterType,				desc: pvMeterType
	reg: 40212, u16/RW,								desc: pvMeterAddress
	reg: 40213, enum16/RW, CustomMeterByteOrder,	desc: customMeterByteOrder
	reg: 40214, enum16/RW, CustomMeterDataType,		desc: customMeterDataType
	reg: 40215, u16/RW,								desc: customMeterFunctionCode
	reg: 40216, u16/RW,								desc: customMeterVoltageReg
	reg: 40217, u16/RW,								desc: customMeterVoltageDivide
	reg: 40218, u16/RW,								desc: customMeterCurrentReg
	reg: 40219, u16/RW,								desc: customMeterCurrentDivide
	reg: 40220, u16/RW,								desc: customMeterPowerReg
	reg: 40221, u16/RW,								desc: customMeterPowerDivide
	reg: 40222, u16/RW,								desc: customMeterEnergyReg
	reg: 40223, u16/RW,								desc: customMeterEnergyDivide
	reg: 40224, u16/RW,								desc: maxRegisterRead
	reg: 40225, u16/RW,								desc: wifiMode
	reg: 40226, u16/RW, A,							desc: maxMainsCurrentLimit


device-template:
	component:
		id: info
		template: DeviceInfo
		element: type, "evse"
		element: name, "SmartEVSE"
		element-map: serial_number, @sn,	desc: , const, "Serial Number"
	component:
		id: evse
		template: EVSE
		element-map: temp, @temp,			desc: °C, const, "Temperature"
		element-map: state, @state
		element-map: error, @error
		component:
			id: charge_control
			template: ChargeControl
			element-map: max_current, @maxChargeCurrent
			element-map: min_current, @minChargeCurrent
			element-map: target_current, @chargeCurrent
	component:
		id: config
		template: Configuration
		component:
			id: system
			template: Configuration
			element-map: mode, @mode,											desc: , config, "EVSE Mode"
			element-map: maxCircuitCurrent, @maxCircuitCurrent,					desc: A, config, "Max Circuit Current", "EVSE Circuit max current [10 - 160]"
			element-map: gridType, @gridType,									desc: , config, "Grid Type", "Grid type to which the Sensorbox is connected"
			element-map: ctCalibration, @ctCalibration,							desc: 1, config, "CT Calibration", "CT calibration multiplier"
			element-map: maxMainsCurrent, @maxMainsCurrent,						desc: A, config, "Max Mains Current", "Maximum current from mains supply [10 - 200]"
			element-map: surplusEnergyStartCurrent, @surplusEnergyStartCurrent,	desc: A, config, "Surplus Energy Start Current", "Surplus energy start current [1 - 16]"
			element-map: stopSolarAfter, @stopSolarAfter,						desc: min, config, "Stop Solar After", "Stop solar charging at 6A after this time [0:Disable, 1 - 60min]"
			element-map: allowGridPower, @allowGridPower,						desc: A, config, "Allow Grid Power", "Allow grid power when solar charging [0 - 6]"
			element-map: mainsMeterType, @mainsMeterType,						desc: , config, "Mains Meter Type"
			element-map: mainsMeterAddress, @mainsMeterAddress,					desc: , config, "Mains Meter Address", "Modbus address of Mains electric meter [10 - 247]"
			element-map: mainsMeterMeasure, @mainsMeterMeasure,					desc: , config, "Mains Meter Measure", "What does Mains electric meter measure"
			element-map: pvMeterType, @pvMeterType,								desc: , config, "PV Meter Type"
			element-map: pvMeterAddress, @pvMeterAddress,						desc: , config, "PV Meter Address", "Modbus address of PV electric meter [10 - 247]"
			element-map: customMeterByteOrder, @customMeterByteOrder,			desc: , config, "Custom Meter Byte Order"
			element-map: customMeterDataType, @customMeterDataType,				desc: , config, "Custom Meter Data Type"
			element-map: customMeterFunctionCode, @customMeterFunctionCode,		desc: , config, "Custom Meter Function Code", "Modbus Function (3/4) of custom electric meter"
			element-map: customMeterVoltageReg, @customMeterVoltageReg,			desc: , config, "Custom Meter Voltage Register", "Register for Voltage (V) of custom electric meter [0 - 65530]"
			element-map: customMeterVoltageDivide, @customMeterVoltageDivide,	desc: , config, "Custom Meter Voltage Divisor", "Divisor for Voltage (V) of custom electric meter [0 - 7]"
			element-map: customMeterCurrentReg, @customMeterCurrentReg,			desc: , config, "Custom Meter Current Register", "Register for Current (A) of custom electric meter [0 - 65530]"
			element-map: customMeterCurrentDivide, @customMeterCurrentDivide,	desc: , config, "Custom Meter Current Divisor", "Divisor for Current (A) of custom electric meter [0 - 7]"
			element-map: customMeterPowerReg, @customMeterPowerReg,				desc: , config, "Custom Meter Power Register", "Register for Power (W) of custom electric meter [0 - 65534]"
			element-map: customMeterPowerDivide, @customMeterPowerDivide,		desc: , config, "Custom Meter Power Divisor", "Divisor for Power (W) of custom electric meter [0 - 7]"
			element-map: customMeterEnergyReg, @customMeterEnergyReg,			desc: , config, "Custom Meter Energy Register", "Register for Energy (kWh) of custom electric meter [0 - 65534]"
			element-map: customMeterEnergyDivide, @customMeterEnergyDivide,		desc: , config, "Custom Meter Energy Divisor", "Divisor for Energy (kWh) of custom electric meter [0 - 7]"
			element-map: maxRegisterRead, @maxRegisterRead,						desc: , config, "Maximum register read (Not implemented)"
			element-map: wifiMode, @wifiMode,									desc: , config, "WiFi Mode"
			element-map: maxMainsCurrentLimit, @maxMainsCurrentLimit,			desc: A, config, "Max Mains Current Limit", "Limit max current draw on MAINS [9:Disable, 10 - 200]"
		component:
			id: node
			template: Configuration
			element-map: cableConfig, @cableConfig,								desc: , config, "Cable Configuration"
			element-map: cableLock, @cableLock,									desc: , config, "Cable Lock"
			element-map: minChargeCurrent, @minChargeCurrent,					desc: A, config, "Min Charge Current", "MIN Charge Current the EV will accept [6 - 16]"
			element-map: maxChargeCurrent, @maxChargeCurrent,					desc: A, config, "Max Charge Current", "MAX Charge Current for this EVSE [6 - 80]"
			element-map: loadBalance, @loadBalance,								desc: , config, "Load Balance"
			element-map: externalSwitchMode, @externalSwitchMode,				desc: , config, "External Switch Mode", "External Switch on pin SW"
			element-map: rcm, @rcm,												desc: , config, "Residual Current Monitor", "Residual Current Monitor on pin RCM"
			element-map: useRfid, @useRfid,										desc: , config, "Use RFID"
			element-map: meterType, @meterType,									desc: , config, "EV Meter Type"
			element-map: meterAddress, @meterAddress,							desc: , config, "EV Meter Address", "Modbus address of EV electric meter [10 - 247]"
