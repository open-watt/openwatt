#
# Legend:
#
# reg: number (40000), type (u16), units (10mAh)
#	desc: id, display_units, sample_frequency, user_description
#	valueid: val0, val1, ...
#	valuedesc: "Value 0", "Value 1", ...
#	map-local: device.component.element
#	map-mb: server_name, register_number_or_id
#

#
# Eastron SDM-120:
#  http://support.innon.com/PowerMeters/SDM120-MOD-MID/Manual/SDM120_PROTOCOL.pdf
#  https://stromz√§hler.eu/media/7e/64/b6/1696582669/sdm120modbus_manual.pdf
#

enum: BaudRate
	_1200: 5, "1200"
	_2400: 0, "2400"
	_4800: 1, "4800"
	_9600: 2, "9600"
	_19200: 3, "19200"
	_38400: 4, "38400"

enum: ParityStop
	no_parity_1_stop: 0, "no parity, 1 stop bit"
	even_parity_1_stop: 1, "even parity, 1 stop bit"
	odd_parity_1_stop: 2, "odd parity, 1 stop bit"
	no_parity_2_stop: 3, "no parity, 2 stop bits"

enum: Pulse1OutputMode
	import_active_energy: 1, "Import active energy"
	total_active_energy: 2, "Total active energy (import + export)"
	export_active_energy: 4, "Export active energy"
	import_reactive_energy: 5, "Import reactive energy"
	total_reactive_energy: 6, "Total reactive energy (import + export)"
	export_reactive_energy: 8, "Export reactive energy"

enum: Pulse1Output
	_1wh: 0, "1Wh/imp"
	_10wh: 1, "10Wh/imp"
	_100wh: 2, "100Wh/imp"
	_1kwh: 3, "1kWh/imp"

enum: MeasurementMode
	mode1: 1, "Mode 1 (total = import)"
	mode2: 2, "Mode 2 (total = import + export)"
	mode3: 3, "Mode 3 (total = import - export)"


registers:
	# float regs
	reg: 30000, f32, V,			desc: voltage
	reg: 30006, f32, A,			desc: current
	reg: 30012, f32, W,			desc: activePower
	reg: 30018, f32, VA,		desc: apparentPower
	reg: 30024, f32, var,		desc: reactivePower
	reg: 30030, f32,			desc: powerFactor
	reg: 30036, f32, deg,		desc: phaseAngle
	reg: 30070, f32, Hz,		desc: frequency
	reg: 30072, f32, kWh,		desc: importActiveEnergy
	reg: 30074, f32, kWh,		desc: exportActiveEnergy
	reg: 30076, f32, kvarh,		desc: importReactiveEnergy
	reg: 30078, f32, kvarh,		desc: exportReactiveEnergy
	reg: 30084, f32, W,			desc: totalSystemPowerDemand
	reg: 30086, f32, W,			desc: maximumTotalSystemPowerDemand
	reg: 30088, f32, W,			desc: importSystemPowerDemand
	reg: 30090, f32, W,			desc: maximumImportSystemPowerDemand
	reg: 30092, f32, W,			desc: exportSystemPowerDemand
	reg: 30094, f32, W,			desc: maximumExportSystemPowerDemand
	reg: 30258, f32, A,			desc: currentDemand
	reg: 30264, f32, A,			desc: maximumCurrentDemand
	reg: 30342, f32, kWh,		desc: totalActiveEnergy
	reg: 30344, f32, kvarh,		desc: totalReactiveEnergy

	# config
	reg: 40002, f32/RW, min,				desc: demandPeriod
	reg: 40010, f32/RW, ms,					desc: relayPulseWidth
	reg: 40012, f32/RW, ms,					desc: pulse1Width
	reg: 40018, enumf32/RW, ParityStop,		desc: networkParityStop
	reg: 40020, f32/RW,						desc: address
	reg: 40028, enumf32/RW, BaudRate,		desc: baudRate
	reg: 40086, enumf32/RW, Pulse1OutputMode, desc: pulse1OutputMode
	reg: 65456, u16/RW,						desc: resetDemandInfo
	reg: 66720, u16/RW,						desc: timeParams
	reg: 67744, u16/RW, s,					desc: timeOfScrollDisplay
	reg: 67760, enum16/RW, Pulse1Output,	desc: pulse1Output
	reg: 67776, enum16/RW, MeasurementMode,	desc: measurementMode

device-template:
	component:
		id: info
		template: DeviceInfo
		element: type, "energy-meter"
		element: name, "Eastron SDM series"
	component:
		id: realtime
		template: RealtimeEnergyMeter
		element: type, "single-phase"
		element-map: voltage, @voltage
		element-map: current, @current
		element-map: power, @activePower
		element-map: apparent, @apparentPower
		element-map: reactive, @reactivePower
		element-map: pf, @powerFactor
		element-map: frequency, @frequency
		element-map: phase, @phaseAngle
	component:
		id: cumulative
		template: CumulativeEnergyMeter
		element: type, "single-phase"
		element-map: import, @importActiveEnergy
		element-map: export, @exportActiveEnergy
		element-map: net, @totalActiveEnergy
		element-map: import_reactive, @importReactiveEnergy
		element-map: export_reactive, @exportReactiveEnergy
		element-map: net_reactive, @totalReactiveEnergy
	component:
		id: demand
		template: DemandEnergyMeter
		element-map: demand, @totalSystemPowerDemand
		element-map: current_demand, @currentDemand
		element-map: import_demand, @importSystemPowerDemand
		element-map: export_demand, @exportSystemPowerDemand
		element-map: max_demand, @maximumTotalSystemPowerDemand
		element-map: max_current_demand, @maximumCurrentDemand
		element-map: max_import_demand, @maximumImportSystemPowerDemand
		element-map: max_export_demand, @maximumExportSystemPowerDemand
	component:
		id: config
		template: Configuration
		element-map: demand_period, @demandPeriod,					desc: min, config, "Demand Period", , "Demand period (default 60 min)"
		element-map: reset_demand_data, @resetDemandInfo,			desc: , config, "Reset Demand Data", "Write 0 to reset demand data"
		element-map: pulse1_energy_type, @pulse1OutputMode,			desc: , config, "Pulse 1 Energy Type", "Energy type measured by pulse 1 output (default export_active_energy)"
		element-map: pulse1_constant, @pulse1Output,				desc: , config, "Pulse 1 Constant", "Energy per pulse for pulse 1 output (default 1Wh/imp)"
		element-map: pulse1_width, @pulse1Width,					desc: ms, config, "Pulse 1 Width", "Pulse 1 width (default 60ms)"
		element-map: relay_pulse_width, @relayPulseWidth,			desc: ms, config, "Relay Pulse Width", "Relay pulse width (default 200ms)"
		element-map: measurement_mode, @measurementMode,			desc: , config, "Measurement Mode", "Total energy calculation mode (default mode2)"
		element-map: time_params, @timeParams,						desc: , config, "Time Parameters", "BCD-encoded time parameters"
		element-map: time_of_scroll_display, @timeOfScrollDisplay,	desc: s, config, "Scroll Display Time", "Time of scroll display (default 0, BCD format)"
		component:
			id: modbus
			template: ModbusConfig
			element-map: address, @address
			element-map: baud_rate, @baudRate
			element-map: parity_and_stop, @networkParityStop,		desc: , config, "Parity and Stop Bits", "Network parity/stop bits (default 1)"
