#
# Legend:
#
# reg: number (40000), type (u16), units (10mAh)
#	desc: id, display_units, sample_frequency, user_description
#	valueid: val0, val1, ...
#	valuedesc: "Value 0", "Value 1", ...
#	map-local: device.component.element
#	map-mb: server_name, register_number_or_id
#

#
# Eastron SDM-120:
#  http://support.innon.com/PowerMeters/SDM120-MOD-MID/Manual/SDM120_PROTOCOL.pdf
#  https://stromz√§hler.eu/media/7e/64/b6/1696582669/sdm120modbus_manual.pdf
#

enum: BaudRate
	_1200: 5, "1200"
	_2400: 0, "2400"
	_4800: 1, "4800"
	_9600: 2, "9600"
	_19200: 3, "19200"
	_38400: 4, "38400"

enum: ParityStop
	no_parity_1_stop: 0, "no parity, 1 stop bit"
	even_parity_1_stop: 1, "even parity, 1 stop bit"
	odd_parity_1_stop: 2, "odd parity, 1 stop bit"
	no_parity_2_stop: 3, "no parity, 2 stop bits"

enum: Pulse1OutputMode
	import_active_energy: 1, "Import active energy"
	total_active_energy: 2, "Total active energy (import + export)"
	export_active_energy: 4, "Export active energy"
	import_reactive_energy: 5, "Import reactive energy"
	total_reactive_energy: 6, "Total reactive energy (import + export)"
	export_reactive_energy: 8, "Export reactive energy"

enum: Pulse1Output
	_1wh: 0, "1Wh/imp"
	_10wh: 1, "10Wh/imp"
	_100wh: 2, "100Wh/imp"
	_1kwh: 3, "1kWh/imp"

enum: MeasurementMode
	mode1: 1, "Mode 1 (total = import)"
	mode2: 2, "Mode 2 (total = import + export)"
	mode3: 3, "Mode 3 (total = import - export)"


registers:
	# float regs
	reg: 30000, f32, V,			desc: voltage, V, realtime, "Voltage"
	reg: 30006, f32, A,			desc: current, A, realtime, "Current"
	reg: 30012, f32, W,			desc: activePower, W, realtime, "Active power"
	reg: 30018, f32, VA,		desc: apparentPower, VA, realtime, "Apparent power"
	reg: 30024, f32, var,		desc: reactivePower, var, realtime, "Reactive power"
	reg: 30030, f32,			desc: powerFactor, , realtime, "Power factor"
	reg: 30036, f32, deg,		desc: phaseAngle, deg, realtime, "Phase angle"
	reg: 30070, f32, Hz,		desc: frequency, Hz, realtime, "Frequency"
	reg: 30072, f32, kWh,		desc: importActiveEnergy, kWh, high, "Import active energy"
	reg: 30074, f32, kWh,		desc: exportActiveEnergy, kWh, high, "Export active energy"
	reg: 30076, f32, kvarh,		desc: importReactiveEnergy, kvarh, high, "Import reactive energy"
	reg: 30078, f32, kvarh,		desc: exportReactiveEnergy, kvarh, high, "Export reactive energy"
	reg: 30084, f32, W,			desc: totalSystemPowerDemand, W, high, "Total system power demand"
	reg: 30086, f32, W,			desc: maximumTotalSystemPowerDemand, W, high, "Maximum Total system power demand"
	reg: 30088, f32, W,			desc: importSystemPowerDemand, W, high, "Import system power demand"
	reg: 30090, f32, W,			desc: maximumImportSystemPowerDemand, W, high, "Maximum Import system power demand"
	reg: 30092, f32, W,			desc: exportSystemPowerDemand, W, high, "Export system power demand"
	reg: 30094, f32, W,			desc: maximumExportSystemPowerDemand, W, high, "Maximum Export system power demand"
	reg: 30258, f32, A,			desc: currentDemand, A, high, "Current demand"
	reg: 30264, f32, A,			desc: maximumCurrentDemand, A, high, "Maximum current demand"
	reg: 30342, f32, kWh,		desc: totalActiveEnergy, kWh, high, "Total active energy"
	reg: 30344, f32, kvarh,		desc: totalReactiveEnergy, kvarh, high, "Total reactive energy"

	#config
	reg: 40002, f32/RW, min,				desc: demandPeriod, min, config, "Demand period (default 60 min)"
	reg: 40010, f32/RW, ms,					desc: relayPulseWidth, ms, config, "Relay Pulse Width (default 200 ms)"
	reg: 40012, f32/RW, ms,					desc: pulse1Width, ms, config, "Pulse 1 width (default 60 ms)"
	reg: 40018, enumf32, ParityStop			desc: networkParityStop, , config, "Network parity/stop bits (default 1)"
	reg: 40020, f32/RW,						desc: address, , config, "Modbus address (default 1)"
	reg: 40028, enumf32/RW, BaudRate		desc: baudRate, , config, "Baud rate (default 2400)"
	reg: 40086, enumf32/RW,	Pulse1OutputMode	desc: pulse1OutputMode, , config, "Pulse 1 output mode (default 4)"
	reg: 65456, u16/RW,						desc: resetDemandInfo, , config, "0 = reset demand info"
	reg: 66720, u16/RW,						desc: timeParams, , config, "Data Format: BCD; Demand Interval, Slide Time, Automatic Scroll Display Interval (Scroll Time), Backlight Time (min-min-s-min). Scroll Time=0: the display does not scroll automatically. Backlight Time=0: Backlight is Always On."
	reg: 67744, u16/RW, s,					desc: timeOfScrollDisplay, s, config, "Time of scroll display (default 0). 0 = does not display in turns. Data Format: BCD"
	reg: 67760, enum16/RW, Pulse1Output		desc: pulse1Output, , config, "Pulse 1 output (default 1Wh/imp)"
	reg: 67776, enum16/RW, MeasurementMode	desc: measurementMode, , config, "Measurement mode (default 2)"

device-template:
	component:
		id: info
		template: DeviceInfo
		element: type, "energy-meter"
		element: name, "Eastron SDM series"
	component:
		id: realtime
		template: RealtimeEnergyMeter
		element: type, "single-phase"
		element-map: voltage, @voltage
		element-map: current, @current
		element-map: power, @activePower
		element-map: apparent, @apparentPower
		element-map: reactive, @reactivePower
		element-map: pf, @powerFactor
		element-map: frequency, @frequency
		element-map: phase, @phaseAngle
	component:
		id: cumulative
		template: CumulativeEnergyMeter
		element: type, "single-phase"
		element-map: total_import, @importActiveEnergy
		element-map: total_export, @exportActiveEnergy
		element-map: total, @totalActiveEnergy
		element-map: total_import_reactive, @importReactiveEnergy
		element-map: total_export_reactive, @exportReactiveEnergy
		element-map: total_reactive, @totalReactiveEnergy
	component:
		id: demand
		template: DemandEnergyMeter
		element-map: demand, @totalSystemPowerDemand
		element-map: current_demand, @currentDemand
		element-map: import_demand, @importSystemPowerDemand
		element-map: export_demand, @exportSystemPowerDemand
		element-map: max_demand, @maximumTotalSystemPowerDemand
		element-map: max_current_demand, @maximumCurrentDemand
		element-map: max_import_demand, @maximumImportSystemPowerDemand
		element-map: max_export_demand, @maximumExportSystemPowerDemand
	component:
		id: config
		template: Configuration
		element-map: demand_period, @demandPeriod
		element-map: pulse1_energy_type, @pulse1OutputMode
		element-map: pulse1_constant, @pulse1Output
		element-map: pulse1_width, @pulse1Width
		element-map: relay_pulse_width, @relayPulseWidth
		element-map: measurement_mode, @measurementMode
		element-map: time_params, @timeParams
		element-map: time_of_scroll_display, @timeOfScrollDisplay
		element-map: reset_demand_info, @resetDemandInfo
		component:
			id: modbus
			template: ModbusConfig
			element-map: address, @address
			element-map: baud_rate, @baudRate
			element-map: parity_and_stop, @networkParityStop
